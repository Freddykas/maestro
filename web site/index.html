<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAESTRO MSL - OFFICIEL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .header { background: #1e3a8a; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .member-count { background: #3b82f6; color: white; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }

        .page { display: none; flex: 1; overflow-y: auto; width: 100%; height: calc(100vh - 60px); }
        .active-page { display: flex; flex-direction: column; }

        /* CONNEXION */
        #login-page { background: #1e3a8a; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }

        /* LISTE DES MEMBRES */
        .user-row { background: white; padding: 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #e2e8f0; cursor: pointer; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background: #1e3a8a; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* CHAT */
        #chat-page { background: #f8fafc; position: relative; }
        .msg-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-bottom: 80px; }
        .bubble { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .sent { background: #1e3a8a; color: white; align-self: flex-end; }
        .received { background: white; color: #334155; align-self: flex-start; border: 1px solid #e2e8f0; }

        /* BARRE DE SAISIE CORRIGÉE */
        .input-bar { background: white; padding: 10px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #e2e8f0; position: absolute; bottom: 0; width: 100%; }
        .input-bar input { flex: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 25px; outline: none; }
        .icon-btn { color: #64748b; font-size: 20px; cursor: pointer; padding: 5px; }
        .send-btn { color: #1e3a8a; font-size: 22px; cursor: pointer; }
        .recording { color: #ef4444; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* APPEL */
        #call-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; }
        #local-video { position: absolute; top: 20px; right: 20px; width: 100px; height: 140px; border-radius: 10px; border: 2px solid #3b82f6; object-fit: cover; }
        .call-controls { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 20px; }
        .btn-call { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header" id="main-header" style="display:none;">
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-arrow-left" id="back-btn" style="display:none;" onclick="showHome()"></i>
            <span id="header-title">MAESTRO MSL</span>
        </div>
        <span id="counter-badge" class="member-count">0 Membre(s)</span>
    </div>

    <div id="login-page" class="page active-page">
        <div class="login-box">
            <h1 style="color:#1e3a8a; margin-bottom:10px;">Qui es-tu ?</h1>
            <p style="margin-bottom:20px; color:#64748b;">Espace Membre ONG</p>
            <input type="text" id="reg-nom" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ccc;" placeholder="Ton Nom Complet">
            <select id="reg-rank" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ccc;">
                <option value="1">1. Président</option>
                <option value="2">2. Secrétaire</option>
                <option value="3">3. Trésorier</option>
                <option value="4" selected>4. Membre</option>
            </select>
            <input type="text" id="reg-poste" style="width:100%; padding:12px; margin-bottom:20px; border-radius:8px; border:1px solid #ccc;" placeholder="Ton Poste">
            <button onclick="saveUser()" style="width:100%; padding:15px; background:#1e3a8a; color:white; border:none; border-radius:8px; font-weight:bold;">SE CONNECTER</button>
        </div>
    </div>

    <div id="members-page" class="page">
        <div id="list-container"></div>
    </div>

    <div id="chat-page" class="page">
        <div style="background:#1e3a8a; padding:10px; display:flex; justify-content:flex-end; gap:20px; color:white;">
            <i class="fas fa-video" onclick="openCallScreen()"></i>
        </div>
        <div class="msg-container" id="chat-content"></div>
        
        <div class="input-bar">
            <label for="file-in" class="icon-btn"><i class="fas fa-paperclip"></i></label>
            <input type="file" id="file-in" style="display:none;" onchange="sendFile(this)">
            
            <input type="text" id="chat-input" placeholder="Écrire un message...">
            
            <i class="fas fa-microphone icon-btn" id="voice-btn" onclick="startVocal()"></i>
            
            <i class="fas fa-paper-plane send-btn" onclick="sendMessage()"></i>
        </div>
    </div>

    <div id="call-screen">
        <video id="remote-video" style="width:100%; height:100%; object-fit:cover;" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="call-controls">
            <button class="btn-call" style="background:rgba(255,255,255,0.2)" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
            <button id="hangup-btn" class="btn-call" style="background:#22c55e" onclick="handleCall()"><i class="fas fa-phone"></i></button>
            <button class="btn-call" style="background:rgba(255,255,255,0.2)" onclick="switchCamera()"><i class="fas fa-sync"></i></button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCKc2567T72Zz9NPxYPl_CQqyK9oFA6e5Q",
            authDomain: "maestro-321be.firebaseapp.com",
            databaseURL: "https://maestro-321be-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "maestro-321be",
            storageBucket: "maestro-321be.firebasestorage.app",
            messagingSenderId: "138915525897",
            appId: "1:138915525897:web:32b731374df144b7414fd8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let myData = JSON.parse(localStorage.getItem('msl_data'));
        let currentChatId = null;
        let localStream, isCalling = false, currentFacingMode = "user";

        window.onload = () => { if (myData) { document.getElementById('main-header').style.display='flex'; showHome(); } };

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById(id).classList.add('active-page');
            document.getElementById('back-btn').style.display = (id === 'chat-page') ? "block" : "none";
        }

        function saveUser() {
            let n = document.getElementById('reg-nom').value, p = document.getElementById('reg-poste').value, r = document.getElementById('reg-rank').value;
            if(!n || !p) return alert("Identifie-toi d'abord");
            myData = { id: "u"+Date.now(), name: n, role: p, rank: parseInt(r) };
            localStorage.setItem('msl_data', JSON.stringify(myData));
            db.ref('users/' + myData.id).set(myData);
            document.getElementById('main-header').style.display='flex';
            showHome();
        }

        function showHome() {
            showPage('members-page');
            document.getElementById('header-title').innerText = "MEMBRES ONG";
            db.ref('users').on('value', s => {
                let cont = document.getElementById('list-container'); cont.innerHTML = "";
                if(s.val()){
                    let members = Object.values(s.val()).sort((a,b) => a.rank - b.rank);
                    document.getElementById('counter-badge').innerText = members.length + " Membres";
                    members.forEach(u => {
                        if(u.id === myData.id) return;
                        let row = document.createElement('div'); row.className = "user-row";
                        row.onclick = () => openChat(u);
                        row.innerHTML = `<div class="avatar">${u.name.charAt(0)}</div><div class="user-info"><h4>${u.name}</h4><p>${u.role}</p></div>`;
                        cont.appendChild(row);
                    });
                }
            });
        }

        function openChat(u) { currentChatId = u.id; showPage('chat-page'); document.getElementById('header-title').innerText = u.name; loadMessages(); }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            if(!input.value.trim() || !currentChatId) return;
            const path = myData.id < currentChatId ? myData.id+"_"+currentChatId : currentChatId+"_"+myData.id;
            db.ref('messages/'+path).push({ sender: myData.id, text: input.value, time: Date.now() });
            input.value = "";
        }

        function loadMessages() {
            const path = myData.id < currentChatId ? myData.id+"_"+currentChatId : currentChatId+"_"+myData.id;
            db.ref('messages/'+path).on('value', s => {
                const cont = document.getElementById('chat-content'); cont.innerHTML = "";
                if(s.val()) Object.values(s.val()).forEach(m => {
                    let b = document.createElement('div');
                    b.className = "bubble " + (m.sender === myData.id ? "sent" : "received");
                    b.innerText = m.text;
                    cont.appendChild(b);
                });
                cont.scrollTop = cont.scrollHeight;
            });
        }

        function sendFile(input) { if(input.files[0]) alert("Document envoyé : " + input.files[0].name); }
        function startVocal() { document.getElementById('voice-btn').classList.toggle('recording'); alert("Enregistrement vocal..."); }

        // CAMERA & APPEL
        function openCallScreen() { document.getElementById('call-screen').style.display = "block"; }
        async function handleCall() {
            if(!isCalling) {
                localStream = await navigator.mediaDevices.getUserMedia({video:{facingMode: currentFacingMode}, audio:true});
                document.getElementById('local-video').srcObject = localStream;
                document.getElementById('hangup-btn').style.background = "#ef4444";
                isCalling = true;
            } else {
                localStream.getTracks().forEach(t => t.stop());
                document.getElementById('call-screen').style.display = "none";
                isCalling = false;
            }
        }
        async function switchCamera() {
            if(!localStream) return;
            currentFacingMode = (currentFacingMode === "user") ? "environment" : "user";
            localStream.getTracks().forEach(t => t.stop());
            localStream = await navigator.mediaDevices.getUserMedia({video:{facingMode: currentFacingMode}, audio:true});
            document.getElementById('local-video').srcObject = localStream;
        }
    </script>
</body>
</html>
