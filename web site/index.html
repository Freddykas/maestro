<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAMUSEL - Système ONG</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --blue: #1e3a8a; --bg: #efeae2; --border: #e2e8f0; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { height: 100vh; display: flex; background: #f0f2f5; overflow: hidden; }

        /* SIDEBAR GAUCHE */
        .sidebar { width: 350px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; font-size: 20px; font-weight: bold; color: var(--blue); border-bottom: 1px solid var(--border); }
        .user-list { flex: 1; overflow-y: auto; }
        .contact-row { display: flex; align-items: center; gap: 12px; padding: 15px; border-bottom: 1px solid #f8fafc; cursor: pointer; }

        /* SECTION MON PROFIL (BAS GAUCHE) */
        .my-profile-section { padding: 20px; background: #f8fafc; border-top: 3px solid var(--blue); }
        .btn-create { width: 100%; padding: 12px; background: var(--blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .profile-card { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #ddd; }

        /* MODAL FORMULAIRE (COMME SUR L'IMAGE) */
        #form-overlay { position: fixed; inset: 0; background: rgba(0, 31, 63, 0.85); z-index: 9999; display: none; align-items: center; justify-content: center; }
        .modal-card { background: white; padding: 30px; border-radius: 20px; width: 450px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        .modal-card h2 { color: var(--blue); margin-bottom: 20px; }
        .photo-upload { width: 100px; height: 100px; border: 2px dashed var(--blue); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; }
        .photo-upload img { width: 100%; height: 100%; object-fit: cover; }
        .modal-card input, .modal-card textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; }

        /* ZONE CHAT */
        .main-chat { flex: 1; display: flex; flex-direction: column; background: var(--bg); }
        .chat-header { padding: 15px 25px; background: #f0f2f5; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; visibility: hidden; }
        .msg-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .input-bar { padding: 15px; background: #f0f2f5; display: flex; gap: 15px; align-items: center; visibility: hidden; }
        .input-bar input { flex: 1; padding: 12px 20px; border-radius: 25px; border: none; outline: none; }
    </style>
</head>
<body>

    <div id="form-overlay">
        <div class="modal-card">
            <h2>Mon Profil MAMUSEL</h2>
            
            <div class="photo-upload" onclick="document.getElementById('file-in').click()">
                <div id="photo-placeholder"><i class="fas fa-camera fa-2x" style="color:#1e3a8a"></i><br><small>Photo</small></div>
                <img id="preview-img" style="display:none">
            </div>
            <input type="file" id="file-in" hidden accept="image/*" onchange="previewFile()">

            <input type="text" id="reg-nom" placeholder="Nom">
            <input type="text" id="reg-prenom" placeholder="Prénom">
            <input type="email" id="reg-email" placeholder="Adresse Email">
            <input type="tel" id="reg-tel" placeholder="N° de téléphone">
            <input type="text" id="reg-poste" placeholder="Ton poste dans l'ONG">
            
            <button onclick="saveMyProfile()" class="btn-create" style="margin-top:10px">ENREGISTRER MES INFOS</button>
            <button onclick="document.getElementById('form-overlay').style.display='none'" style="background:none; border:none; color:red; margin-top:15px; cursor:pointer">Annuler</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">MAMUSEL-ONG</div>
        <div class="user-list" id="others-list"></div>

        <div class="my-profile-section">
            <button id="create-btn" class="btn-create" onclick="document.getElementById('form-overlay').style.display='flex'">
                <i class="fas fa-camera"></i> Créer mon profil
            </button>
            <div id="me-card" class="profile-card" style="display:none">
                <img id="me-pic" src="" class="avatar">
                <div>
                    <b id="me-name">Nom</b><br>
                    <small id="me-poste" style="color:gray"></small>
                </div>
            </div>
        </div>
    </div>

    <div class="main-chat">
        <div class="chat-header" id="chat-header">
            <div style="display:flex; align-items:center; gap:10px">
                <img id="head-pic" src="" class="avatar" style="width:35px; height:35px;">
                <b id="head-name">Discussion</b>
            </div>
            <div style="display:flex; gap:20px; color:#54656f">
                <i class="fas fa-video"></i><i class="fas fa-phone"></i>
                <i class="fas fa-sign-out-alt" onclick="localStorage.clear(); location.reload();" style="cursor:pointer"></i>
            </div>
        </div>
        <div class="msg-box" id="msg-box"></div>
        <div class="input-bar" id="input-bar">
            <i class="fas fa-paperclip"></i>
            <input type="text" id="msg-in" placeholder="Tape ton message..." onkeypress="if(event.key==='Enter') send()">
            <i class="fas fa-microphone"></i>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCKc2567T72Zz9NPxYPl_CQqyK9oFA6e5Q",
            authDomain: "maestro-321be.firebaseapp.com",
            databaseURL: "https://maestro-321be-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "maestro-321be",
            appId: "1:138915525897:web:32b731374df144b7414fd8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myData = JSON.parse(localStorage.getItem('mamusel_final'));
        let photoBase64 = "";

        if(myData) {
            document.getElementById('create-btn').style.display = 'none';
            document.getElementById('me-card').style.display = 'flex';
            document.getElementById('me-name').innerText = myData.prenom + " " + myData.nom;
            document.getElementById('me-poste').innerText = myData.poste;
            document.getElementById('me-pic').src = myData.pic;
            listenUsers();
        }

        // PREVISUALISATION DE LA PHOTO DEPUIS L'ORDINATEUR
        function previewFile() {
            const file = document.getElementById('file-in').files[0];
            const reader = new FileReader();
            reader.onloadend = function() {
                photoBase64 = reader.result;
                document.getElementById('preview-img').src = photoBase64;
                document.getElementById('preview-img').style.display = 'block';
                document.getElementById('photo-placeholder').style.display = 'none';
            }
            if(file) reader.readAsDataURL(file);
        }

        // ENREGISTREMENT DES INFOS SAISIES MANUELLEMENT
        function saveMyProfile() {
            const u = {
                uid: "u" + Date.now(),
                nom: document.getElementById('reg-nom').value,
                prenom: document.getElementById('reg-prenom').value,
                email: document.getElementById('reg-email').value,
                tel: document.getElementById('reg-tel').value,
                poste: document.getElementById('reg-poste').value,
                pic: photoBase64 || "https://cdn-icons-png.flaticon.com/512/149/149071.png"
            };

            if(!u.nom || !u.prenom) return alert("Remplissez le nom et le prénom !");

            db.ref('final_ong/users/' + u.uid).set(u).then(() => {
                localStorage.setItem('mamusel_final', JSON.stringify(u));
                location.reload();
            });
        }

        function listenUsers() {
            db.ref('final_ong/users').on('value', snap => {
                const list = document.getElementById('others-list'); list.innerHTML = "";
                snap.forEach(c => {
                    const u = c.val();
                    if(u.uid !== myData.uid) {
                        const d = document.createElement('div');
                        d.className = "contact-row";
                        d.onclick = () => {
                            activeTarget = u;
                            document.getElementById('chat-header').style.visibility = 'visible';
                            document.getElementById('input-bar').style.visibility = 'visible';
                            document.getElementById('head-name').innerText = u.prenom;
                            document.getElementById('head-pic').src = u.pic;
                        };
                        d.innerHTML = `<img src="${u.pic}" class="avatar"> <b>${u.prenom} ${u.nom}</b>`;
                        list.appendChild(d);
                    }
                });
            });
        }
    </script>
</body>
</html>
