<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAMUSEL - ONG Connect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --blue: #1e3a8a; --bg: #efeae2; --green: #25d366; --red: #ff3b30; --white: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { height: 100vh; display: flex; background: #f0f2f5; overflow: hidden; }

        /* ECRAN D'INSCRIPTION */
        #overlay { position: fixed; inset: 0; background: var(--blue); z-index: 15000; display: flex; align-items: center; justify-content: center; }
        .modal { background: white; padding: 30px; border-radius: 20px; width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .upload-area { width: 120px; height: 120px; border: 3px dashed var(--blue); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative; background: #f8fafc; }
        .upload-area img { width: 100%; height: 100%; object-fit: cover; }
        .modal input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        .btn-save { width: 100%; padding: 15px; background: var(--blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .btn-save:hover { background: #152a61; }

        /* SIDEBAR */
        .sidebar { width: 350px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; background: var(--white); border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h2 { color: var(--blue); font-size: 20px; }
        #users-list { flex: 1; overflow-y: auto; }
        .user-row { display: flex; align-items: center; gap: 12px; padding: 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; transition: 0.2s; }
        .user-row:hover { background: #f1f5f9; }
        .my-zone { padding: 15px; background: #f1f5f9; border-top: 2px solid var(--blue); display: flex; align-items: center; gap: 10px; }

        /* ZONE DE CHAT / APPEL */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        .chat-header { padding: 15px; background: #f0f2f5; border-bottom: 1px solid #ddd; display: none; justify-content: space-between; align-items: center; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #ccc; }

        /* ECRAN APPEL PLEIN ECRAN */
        #call-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .caller-img { width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--green); margin-bottom: 20px; object-fit: cover; }
        .call-btns { display: flex; gap: 40px; margin-top: 30px; }
        .btn-call { width: 70px; height: 70px; border-radius: 50%; border: none; color: white; font-size: 25px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="overlay" style="display: none;">
        <div class="modal">
            <h2 style="color:var(--blue); margin-bottom:10px;">Créer mon Profil</h2>
            <div class="upload-area" onclick="document.getElementById('pc-file').click()">
                <div id="plus-icon"><i class="fas fa-camera fa-2x"></i><br><small>Photo PC</small></div>
                <img id="photo-preview" style="display:none">
            </div>
            <input type="file" id="pc-file" hidden accept="image/*" onchange="handleFile()">
            <input type="text" id="reg-prenom" placeholder="Ton Prénom">
            <input type="text" id="reg-nom" placeholder="Ton Nom">
            <input type="text" id="reg-poste" placeholder="Ton Poste (ex: Coordinateur)">
            <button class="btn-save" onclick="saveProfile()">DÉMARRER</button>
        </div>
    </div>

    <div id="call-screen">
        <img id="caller-pic" src="" class="caller-img">
        <h1 id="caller-name">Appel entrant...</h1>
        <div class="call-btns">
            <button class="btn-call" style="background:var(--red);" onclick="endCall()"><i class="fas fa-phone-slash"></i></button>
            <button class="btn-call" style="background:var(--green);" onclick="answerCall()"><i class="fas fa-video"></i></button>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>MAMUSEL</h2>
            <i class="fas fa-sync-alt" style="cursor:pointer; color:var(--blue);" onclick="location.reload()" title="Actualiser"></i>
        </div>
        <div id="users-list"></div>
        <div class="my-zone" id="my-info"></div>
    </div>

    <div class="chat-area">
        <div class="chat-header" id="c-head">
            <div style="display:flex; align-items:center; gap:10px">
                <img id="target-pic" src="" class="avatar">
                <b id="target-name">...</b>
            </div>
            <div style="display:flex; gap:20px;">
                <i class="fas fa-video" style="cursor:pointer; color:var(--blue); font-size:20px;" onclick="makeCall('Vidéo')"></i>
                <i class="fas fa-phone-alt" style="cursor:pointer; color:var(--blue); font-size:20px;" onclick="makeCall('Vocal')"></i>
                <i class="fas fa-broom" title="Nettoyer TOUS les profils" style="cursor:pointer; color:red; font-size:20px;" onclick="dangerDeleteAll()"></i>
            </div>
        </div>
        <div id="welcome-msg" style="flex:1; display:flex; align-items:center; justify-content:center; color:#999; flex-direction:column;">
            <i class="fas fa-comments fa-4x" style="margin-bottom:15px; opacity:0.2;"></i>
            <p>Sélectionnez un membre de l'ONG pour discuter</p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCKc2567T72Zz9NPxYPl_CQqyK9oFA6e5Q",
            authDomain: "maestro-321be.firebaseapp.com",
            databaseURL: "https://maestro-321be-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "maestro-321be",
            appId: "1:138915525897:web:32b731374df144b7414fd8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myData = JSON.parse(localStorage.getItem('mamusel_vFinal_PC'));
        let selectedBase64 = "";
        let currentTarget = null;

        // VERIFICATION PROFIL
        if(!myData) { document.getElementById('overlay').style.display = 'flex'; } 
        else { startSystem(); }

        // GESTION PHOTO PC
        function handleFile() {
            const file = document.getElementById('pc-file').files[0];
            const reader = new FileReader();
            reader.onloadend = () => {
                selectedBase64 = reader.result;
                document.getElementById('photo-preview').src = selectedBase64;
                document.getElementById('photo-preview').style.display = 'block';
                document.getElementById('plus-icon').style.display = 'none';
            };
            if(file) reader.readAsDataURL(file);
        }

        // ENREGISTRER FERDINAND
        function saveProfile() {
            const data = {
                uid: "u" + Date.now(),
                nom: document.getElementById('reg-nom').value,
                prenom: document.getElementById('reg-prenom').value,
                poste: document.getElementById('reg-poste').value,
                pic: selectedBase64 || "https://via.placeholder.com/150"
            };
            if(!data.nom || !data.prenom) return alert("Remplis ton nom et prénom !");
            
            db.ref('users/' + data.uid).set(data).then(() => {
                localStorage.setItem('mamusel_vFinal_PC', JSON.stringify(data));
                location.reload();
            });
        }

        // SYSTEME PRINCIPAL
        function startSystem() {
            document.getElementById('my-info').innerHTML = `
                <img src="${myData.pic}" class="avatar">
                <div><b>${myData.prenom} (Moi)</b><br><small>${myData.poste}</small></div>
                <i class="fas fa-sign-out-alt" onclick="logout()" style="margin-left:auto; cursor:pointer; color:red;"></i>`;

            // Liste des membres (sync en temps réel)
            db.ref('users').on('value', snap => {
                const list = document.getElementById('users-list'); list.innerHTML = "";
                snap.forEach(c => {
                    const u = c.val();
                    if(u.uid !== myData.uid) {
                        const d = document.createElement('div');
                        d.className = "user-row";
                        d.onclick = () => {
                            currentTarget = u;
                            document.getElementById('welcome-msg').style.display = 'none';
                            document.getElementById('c-head').style.display = 'flex';
                            document.getElementById('target-name').innerText = u.prenom + " " + u.nom;
                            document.getElementById('target-pic').src = u.pic;
                        };
                        d.innerHTML = `<img src="${u.pic}" class="avatar"><div><b>${u.prenom} ${u.nom}</b><br><small>${u.poste}</small></div>`;
                        list.appendChild(d);
                    }
                });
            });

            // Ecouteur d'appels entrants
            db.ref('calls/' + myData.uid).on('value', snap => {
                const call = snap.val();
                if(call && call.status === 'ringing') {
                    document.getElementById('call-screen').style.display = 'flex';
                    document.getElementById('caller-name').innerText = call.fromName;
                    document.getElementById('caller-pic').src = call.fromPic;
                } else {
                    document.getElementById('call-screen').style.display = 'none';
                }
            });
        }

        // FONCTIONS APPEL
        function makeCall(type) {
            if(!currentTarget) return;
            db.ref('calls/' + currentTarget.uid).set({
                fromName: myData.prenom,
                fromPic: myData.pic,
                status: 'ringing'
            });
            alert("Appel " + type + " envoyé...");
        }

        function endCall() {
            db.ref('calls/' + myData.uid).remove();
        }

        function answerCall() {
            alert("Connexion vidéo établie !");
            endCall();
        }

        // --- LA FONCTION QUE TU AS DEMANDÉ POUR SUPPRIMER LES PROFILS ---
        function dangerDeleteAll() {
            if(confirm("ATTENTION : Veux-tu supprimer TOUS les profils de la base de données ?")) {
                db.ref('users').remove().then(() => {
                    localStorage.clear();
                    location.reload();
                });
            }
        }

        function logout() {
            if(confirm("Se déconnecter de ce profil ?")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
