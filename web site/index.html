<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAMUSEL ONG - Officiel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --main-blue: #1e3a8a; --bg-gray: #f0f2f5; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-gray); height: 100vh; display: flex; overflow: hidden; cursor: none; }
        
        /* CURSEUR MAGIQUE (Inversion de couleur) */
        #cursor { width: 20px; height: 20px; background: white; border-radius: 50%; position: fixed; pointer-events: none; z-index: 99999; mix-blend-mode: difference; transform: translate(-50%, -50%); display: none; }

        /* STRUCTURE */
        .side-icons { width: 60px; background: #f0f2f5; border-right: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; padding: 15px 0; }
        .sidebar-list { width: 350px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #efeae2; }

        /* AUTHENTIFICATION */
        #auth-screen { position: fixed; inset: 0; background: var(--main-blue); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 450px; }
        .auth-card input, .auth-card select { width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 5px; }

        /* LISTES */
        .header-box { padding: 15px; background: #f0f2f5; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .contact-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .contact-item:hover { background: #f9f9f9; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--main-blue); color: white; display: flex; align-items: center; justify-content: center; }

        /* CHAT */
        .messages-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 70%; padding: 10px; border-radius: 10px; font-size: 14px; position: relative; }
        .msg.sent { align-self: flex-end; background: #d9fdd3; }
        .msg.received { align-self: flex-start; background: white; }
        .msg-time { font-size: 10px; color: #888; margin-top: 5px; display: block; text-align: right; }

        /* APPEL SCREEN */
        #call-ui { position: fixed; inset: 0; background: #000; z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .call-btns { display: flex; gap: 20px; margin-top: 30px; }
        .btn-round { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; cursor: pointer; font-size: 20px; }
        
        /* HISTORIQUE APPELS */
        .call-log { font-size: 12px; margin-top: 4px; display: flex; align-items: center; gap: 5px; }
        .missed { color: #ef4444; }
        .outgoing { color: #22c55e; }
    </style>
</head>
<body>

    <div id="cursor"></div>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="text-align:center; color:var(--main-blue)">Créer ton profil MAMUSEL</h2>
            <input type="text" id="reg-name" placeholder="Nom Complet">
            <input type="email" id="reg-email" placeholder="Email">
            <input type="text" id="reg-tel" placeholder="Téléphone">
            <input type="text" id="reg-poste" placeholder="Poste dans l'ONG">
            <input type="text" id="reg-pays" placeholder="Pays">
            <input type="password" id="reg-code" placeholder="Code secret (mamusel est mon entreprise)">
            <button onclick="handleSignUp()" style="width:100%; padding:15px; background:var(--main-blue); color:white; border:none; margin-top:20px; border-radius:8px; cursor:pointer;">CONFIRMER L'INSCRIPTION</button>
        </div>
    </div>

    <div class="side-icons">
        <i class="fas fa-comment" onclick="showView('chats')"></i>
        <i class="fas fa-phone" onclick="showView('calls')"></i>
        <img src="" id="my-avatar-btn" style="width:35px; height:35px; border-radius:50%; margin-top:auto; cursor:pointer;" onclick="viewMyProfile()">
    </div>

    <div class="sidebar-list">
        <div class="header-box">
            <span id="view-title">Discussions</span>
        </div>
        <div id="list-content" style="overflow-y:auto; flex:1;"></div>
    </div>

    <div class="chat-area">
        <div class="header-box" id="chat-header" style="display:none;">
            <div id="active-contact-info" style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                <div class="avatar" id="header-avatar"></div>
                <div id="header-name">Nom</div>
            </div>
            <div style="display:flex; gap:20px;">
                <i class="fas fa-phone" onclick="startCall('audio')"></i>
                <i class="fas fa-video" onclick="startCall('video')"></i>
            </div>
        </div>
        <div class="messages-box" id="msg-container"></div>
        <div class="header-box" id="input-area" style="display:none;">
            <input type="text" id="message-input" style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd; outline:none;" placeholder="Écrire...">
            <button onclick="sendRealMessage()" style="background:none; border:none; color:var(--main-blue); margin-left:10px;"><i class="fas fa-paper-plane fa-lg"></i></button>
        </div>
    </div>

    <div id="call-ui">
        <div class="avatar" style="width:120px; height:120px; font-size:40px;" id="call-avatar">?</div>
        <h2 id="call-user-name" style="margin-top:20px;">Utilisateur</h2>
        <p id="call-status">Appel en cours...</p>
        <div class="call-btns">
            <button class="btn-round" style="background:#ef4444;" onclick="endCall()"><i class="fas fa-phone-slash"></i></button>
            <button class="btn-round" style="background:#22c55e;"><i class="fas fa-microphone"></i></button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // CONFIGURATION FIREBASE (La tienne)
        const firebaseConfig = {
            apiKey: "AIzaSyCKc2567T72Zz9NPxYPl_CQqyK9oFA6e5Q",
            authDomain: "maestro-321be.firebaseapp.com",
            databaseURL: "https://maestro-321be-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "maestro-321be",
            storageBucket: "maestro-321be.firebasestorage.app",
            messagingSenderId: "138915525897",
            appId: "1:138915525897:web:32b731374df144b7414fd8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myProfile = JSON.parse(localStorage.getItem('mamusel_user'));
        let currentTarget = null;
        let currentView = 'chats';

        // GESTION SOURIS
        const cursor = document.getElementById('cursor');
        document.addEventListener('mousemove', (e) => {
            cursor.style.display = 'block';
            cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px';
        });

        // INSCRIPTION
        function handleSignUp() {
            const code = document.getElementById('reg-code').value;
            if(code !== "mamusel est mon entreprise") return alert("Code secret invalide");
            
            const user = {
                uid: "u" + Date.now(),
                name: document.getElementById('reg-name').value,
                email: document.getElementById('reg-email').value,
                tel: document.getElementById('reg-tel').value,
                poste: document.getElementById('reg-poste').value,
                pays: document.getElementById('reg-pays').value
            };
            
            db.ref('users/' + user.uid).set(user);
            localStorage.setItem('mamusel_user', JSON.stringify(user));
            location.reload();
        }

        if(myProfile) {
            document.getElementById('auth-screen').style.display = 'none';
            loadApp();
        }

        function loadApp() {
            loadMembers();
            db.ref('users/' + myProfile.uid).on('value', s => {
                if(s.val()) document.getElementById('my-avatar-btn').src = `https://ui-avatars.com/api/?name=${s.val().name}&background=1e3a8a&color=fff`;
            });
        }

        function loadMembers() {
            db.ref('users').on('value', s => {
                const list = document.getElementById('list-content');
                list.innerHTML = "";
                if(currentView === 'chats') {
                    document.getElementById('view-title').innerText = "Discussions";
                    s.forEach(child => {
                        const user = child.val();
                        if(user.uid === myProfile.uid) return;
                        const item = document.createElement('div');
                        item.className = "contact-item";
                        item.onclick = () => openChat(user);
                        item.innerHTML = `<div class="avatar">${user.name[0]}</div><div><b>${user.name}</b><br><small>${user.poste}</small></div>`;
                        list.appendChild(item);
                    });
                } else {
                    loadCallHistory();
                }
            });
        }

        function openChat(user) {
            currentTarget = user;
            document.getElementById('chat-header').style.display = 'flex';
            document.getElementById('input-area').style.display = 'flex';
            document.getElementById('header-name').innerText = user.name;
            document.getElementById('header-avatar').innerText = user.name[0];
            loadMessages();
        }

        function sendRealMessage() {
            const text = document.getElementById('message-input').value;
            if(!text || !currentTarget) return;
            const chatID = myProfile.uid < currentTarget.uid ? myProfile.uid + "_" + currentTarget.uid : currentTarget.uid + "_" + myProfile.uid;
            db.ref('chats/' + chatID).push({
                sender: myProfile.uid,
                text: text,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                date: new Date().toLocaleDateString()
            });
            document.getElementById('message-input').value = "";
        }

        function loadMessages() {
            const chatID = myProfile.uid < currentTarget.uid ? myProfile.uid + "_" + currentTarget.uid : currentTarget.uid + "_" + myProfile.uid;
            db.ref('chats/' + chatID).on('value', s => {
                const container = document.getElementById('msg-container');
                container.innerHTML = "";
                s.forEach(child => {
                    const m = child.val();
                    const div = document.createElement('div');
                    div.className = `msg ${m.sender === myProfile.uid ? 'sent' : 'received'}`;
                    div.innerHTML = `${m.text} <span class="msg-time">${m.time}</span>`;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        // APPELS ET HISTORIQUE
        function startCall(type) {
            if(!currentTarget) return;
            document.getElementById('call-ui').style.display = 'flex';
            document.getElementById('call-user-name').innerText = currentTarget.name;
            document.getElementById('call-avatar').innerText = currentTarget.name[0];
            
            // Enregistrer dans l'historique
            db.ref('calls/' + myProfile.uid).push({
                targetName: currentTarget.name,
                type: type,
                status: 'Sortant',
                time: new Date().toLocaleString()
            });

            // Demander accès Caméra/Micro
            navigator.mediaDevices.getUserMedia({video: type === 'video', audio: true})
            .then(stream => { console.log("Accès accordé"); })
            .catch(err => { alert("Erreur accès média : " + err); });
        }

        function endCall() {
            document.getElementById('call-ui').style.display = 'none';
        }

        function showView(v) {
            currentView = v;
            loadMembers();
        }

        function loadCallHistory() {
            document.getElementById('view-title').innerText = "Appels récents";
            db.ref('calls/' + myProfile.uid).limitToLast(10).on('value', s => {
                const list = document.getElementById('list-content');
                list.innerHTML = "";
                s.forEach(child => {
                    const c = child.val();
                    const item = document.createElement('div');
                    item.className = "contact-item";
                    item.innerHTML = `
                        <div class="avatar">${c.targetName[0]}</div>
                        <div style="flex:1">
                            <b>${c.targetName}</b>
                            <div class="call-log ${c.status === 'Manqué' ? 'missed' : 'outgoing'}">
                                <i class="fas fa-phone"></i> ${c.status} • ${c.time}
                            </div>
                        </div>
                        <i class="fas fa-${c.type === 'video' ? 'video' : 'phone'} color:var(--main-blue)"></i>
                    `;
                    list.appendChild(item);
                });
            });
        }
    </script>
</body>
</html>
